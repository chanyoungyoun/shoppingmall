<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì£¼ë¬¸ ë‚´ì—­</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
      max-width: 900px;
      margin: 0 auto;
      padding: 0;
      font-family: 'Arial', sans-serif;
      background: #f8f8f8;
    }
    header {
      background-color: #333;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    h1 {
      text-align: center;
      margin: 30px 0 20px;
    }
    .date-group {
      margin: 0 20px 40px;
    }
    .date-header {
      font-size: 20px;
      font-weight: bold;
      margin: 25px 0 10px;
      border-bottom: 2px solid #ddd;
      padding-bottom: 5px;
    }
    .order-box {
      border: 1px solid #ccc;
      background: white;
      padding: 16px;
      margin-bottom: 10px;
      border-radius: 10px;
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .order-box img {
      width: 80px;
      height: 80px;
      object-fit: cover;
    }
    .order-details {
      flex: 1;
    }
    .order-details p {
      margin: 2px 0;
    }
    .order-meta {
      font-size: 13px;
      color: gray;
    }
    .empty {
      text-align: center;
      margin-top: 60px;
      color: gray;
    }
  </style>
</head>
<body>
  <header onclick="location.href='/index.html'">
    ì°¬ì˜ì´ì˜ ì¡í™”ìƒì 
  </header>

  <h1>ğŸ§¾ ì£¼ë¬¸ ë‚´ì—­</h1>
  <div id="orders-container"></div>

  <script>
    const user = JSON.parse(localStorage.getItem('user'));
    const token = localStorage.getItem('token');
    const ordersContainer = document.getElementById('orders-container');

    if (!user || !token) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      location.href = '/login.html';
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      if (isNaN(date)) return 'ë‚ ì§œ ì—†ìŒ';
      const yyyy = date.getFullYear();
      const mm = date.getMonth() + 1;
      const dd = date.getDate();
      return `${yyyy}. ${mm}. ${dd}`;
    }

    function formatDelivery(dateStr) {
      const date = new Date(dateStr);
      if (isNaN(date)) return 'ë°°ì†¡ì¼ ë¯¸ì •';
      date.setDate(date.getDate() + 1);
      return `${date.getMonth() + 1}/${date.getDate()}(í™”) ë„ì°©`;
    }

    async function loadOrders() {
      try {
        const res = await fetch(`/payment/${user.userNumber}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!res.ok) {
          alert('ì£¼ë¬¸ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨');
          return;
        }

        const orders = await res.json();

        if (!orders.length) {
          ordersContainer.innerHTML = `<p class="empty">ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
          return;
        }

        const grouped = {};
        for (const order of orders) {
          const orderDate = formatDate(order.CreatedAt);
          if (!grouped[orderDate]) grouped[orderDate] = [];
          grouped[orderDate].push(order);
        }

        ordersContainer.innerHTML = '';

        for (const [date, group] of Object.entries(grouped).sort((a, b) => new Date(b[0]) - new Date(a[0]))) {
          const dateDiv = document.createElement('div');
          dateDiv.className = 'date-group';

          const dateHeader = document.createElement('div');
          dateHeader.className = 'date-header';
          dateHeader.innerText = `${date} ì£¼ë¬¸`;
          dateDiv.appendChild(dateHeader);

          for (const order of group) {
            const box = document.createElement('div');
            box.className = 'order-box';

            box.innerHTML = `
              <img src="${order.ImagePath ? '/' + order.ImagePath.replace(/^\/?/, '') : 'noimage.jpg'}" />
              <div class="order-details">
                <p><strong>${order.ProductName}</strong></p>
                <p>ìˆ˜ëŸ‰: ${order.ProductCnt}ê°œ</p>
                <p>ì´ ê¸ˆì•¡: ${Number(order.TotalPrice).toLocaleString()}ì›</p>
                <p class="order-meta">ë°°ì†¡ì™„ë£Œ Â· ${formatDelivery(order.CreatedAt)}</p>
              </div>
            `;

            dateDiv.appendChild(box);
          }

          ordersContainer.appendChild(dateDiv);
        }
      } catch (err) {
        console.error('ì£¼ë¬¸ ë‚´ì—­ ë¡œë”© ì˜¤ë¥˜:', err);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    loadOrders();
  </script>
</body>
</html>
