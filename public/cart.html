<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì¥ë°”êµ¬ë‹ˆ</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    header {
      background-color: #333;
      color: white;
      padding: 15px;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- âœ… ì°¬ì˜ì´ì˜ ì¡í™”ìƒì  ë°°ë„ˆ -->
  <header onclick="location.href='index.html'">
    ì°¬ì˜ì´ì˜ ì¡í™”ìƒì 
  </header>

  <main class="cart-container">
    <div class="cart-items" id="cart-items">
      <button class="select-toggle" onclick="toggleSelectAll()">ì „ì²´ ì„ íƒ/í•´ì œ</button>
    </div>

    <div class="cart-summary">
      <div class="summary-title">ğŸ—ƒï¸ ì£¼ë¬¸ ì˜ˆì‚° ê¸ˆì•¡</div>
      <div class="summary-line">ì´ ìƒí’ˆ ìˆ˜: <span id="total-count">0</span>ê°œ</div>
      <div class="summary-line">ì´ ìƒí’ˆ ê¸ˆì•¡: <span id="total-price">0</span>ì›</div>
      <hr class="summary-divider" />
      <div class="summary-total">ì´í•©: <span id="total-final">0</span>ì›</div>
      <button class="checkout-btn">êµ¬ë§¤í•˜ê¸°</button>
    </div>
  </main>

  <script>
    const token = localStorage.getItem('token');
    const cartItemsEl = document.getElementById('cart-items');
    let cartList = [];

    if (!token) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      location.href = '/login.html';
    }

    async function loadCart() {
      try {
        const res = await fetch('/cart/me', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!res.ok) {
          alert('ì¸ì¦ ì˜¤ë¥˜! ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
          location.href = '/login.html';
          return;
        }

        cartList = await res.json();

        if (!cartList.length) {
          cartItemsEl.innerHTML = '<p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</p>';
          return;
        }

        cartItemsEl.querySelectorAll('.cart-item-box').forEach(el => el.remove());

        for (const item of cartList) {
          const box = document.createElement('div');
          box.className = 'cart-item-box';

          const div = document.createElement('div');
          div.className = 'cart-item';
          div.dataset.id = item.cartId;

          div.innerHTML = `
            <input type="checkbox" class="check-item" data-id="${item.cartId}" checked />
            <img src="${item.ImagePath ? '/' + item.ImagePath.replace(/^\/?/, '') : 'noimage.jpg'}" alt="${item.ProductName}" />
            <div>
              <h3>${item.ProductName}</h3>
              <p>ìˆ˜ëŸ‰: 
                <input type="number" class="qty-input" data-id="${item.cartId}" value="${item.quantity}" min="1" />
              </p>
              <p>í•©ê³„: <span class="item-total" data-id="${item.cartId}">${(item.quantity * item.Price).toLocaleString()}</span>ì›</p>
            </div>
            <button class="delete-btn" data-id="${item.cartId}">ì‚­ì œ</button>
          `;

          box.appendChild(div);
          cartItemsEl.insertBefore(box, cartItemsEl.querySelector('.select-toggle'));
        }

        attachEvents();
        calculateTotal();
      } catch (err) {
        console.error('ì¥ë°”êµ¬ë‹ˆ ë¡œë”© ì‹¤íŒ¨:', err);
        alert('ì¥ë°”êµ¬ë‹ˆ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    function attachEvents() {
      document.querySelectorAll('.qty-input').forEach(input => {
        input.addEventListener('input', async e => {
          const cartId = Number(e.target.dataset.id);
          const qty = parseInt(e.target.value);
          if (!isNaN(qty) && qty > 0) {
            const item = cartList.find(i => i.cartId === cartId);
            item.quantity = qty;

            const totalEl = document.querySelector(`.item-total[data-id="${cartId}"]`);
            totalEl.innerText = (item.Price * qty).toLocaleString();

            calculateTotal();
          }
        });
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async e => {
          const cartId = Number(e.target.dataset.id);
          await fetch(`/cart/${cartId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          loadCart();
        });
      });

      document.querySelectorAll('.check-item').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          calculateTotal();
        });
      });
    }

    function calculateTotal() {
      let totalCount = 0;
      let totalPrice = 0;

      document.querySelectorAll('.cart-item').forEach(item => {
        const checkbox = item.querySelector('.check-item');
        const qtyInput = item.querySelector('.qty-input');
        const cartId = Number(item.dataset.id);
        const product = cartList.find(i => i.cartId === cartId);

        if (checkbox.checked) {
          const quantity = parseInt(qtyInput.value);
          totalCount += quantity;
          totalPrice += quantity * product.Price;
        }
      });

      document.getElementById('total-count').innerText = totalCount;
      document.getElementById('total-price').innerText = totalPrice.toLocaleString();
      document.getElementById('total-final').innerText = totalPrice.toLocaleString();
    }

    function toggleSelectAll() {
      const checkboxes = document.querySelectorAll('.check-item');
      const allChecked = [...checkboxes].every(c => c.checked);
      checkboxes.forEach(c => (c.checked = !allChecked));
      calculateTotal();
    }

    document.querySelector('.checkout-btn').addEventListener('click', () => {
      const selected = [];
      document.querySelectorAll('.cart-item').forEach(item => {
        const checkbox = item.querySelector('.check-item');
        const cartId = Number(item.dataset.id);
        if (checkbox.checked) {
          const qty = item.querySelector('.qty-input').value;
          const product = cartList.find(i => i.cartId === cartId);
          selected.push({
            cartId,
            productID: product.ProductID,
            productName: product.ProductName,
            productCnt: qty,
            price: product.Price,
            imagePath: product.ImagePath
          });
        }
      });

      if (!selected.length) {
        alert('ì„ íƒëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      localStorage.setItem('orderItems', JSON.stringify(selected));
      location.href = '/order.html';
    });

    loadCart();
  </script>
</body>
</html>
