<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì£¼ë¬¸/ê²°ì œ</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 0 20px;
    }
    header {
      background-color: #333;
      color: white;
      padding: 15px;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
    }
    h1 {
      text-align: center;
      margin: 30px 0 20px;
    }
    .section {
      margin-bottom: 30px;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 8px;
    }
    .section h2 {
      margin-bottom: 10px;
    }
    .order-item {
      display: flex;
      gap: 20px;
      align-items: center;
      margin-bottom: 10px;
    }
    .order-item img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border: 1px solid #ccc;
    }
    .summary {
      font-size: 18px;
      font-weight: bold;
    }
    .btn {
      background-color: royalblue;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    .btn:hover {
      background-color: #0a4bbf;
    }
    input {
      padding: 8px;
      width: 100%;
      margin-top: 5px;
    }
    label {
      display: block;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <!-- âœ… ì°¬ì˜ì´ì˜ ì¡í™”ìƒì  ë°°ë„ˆ -->
  <header onclick="location.href='index.html'">
    ì°¬ì˜ì´ì˜ ì¡í™”ìƒì 
  </header>

  <h1>ğŸ§¾ ì£¼ë¬¸ / ê²°ì œ</h1>

  <div class="section" id="order-items">
    <h2>ğŸ“¦ ì£¼ë¬¸ ìƒí’ˆ</h2>
  </div>

  <div class="section">
    <h2>ğŸ  ë°°ì†¡ì§€ ì •ë³´</h2>
    <label>ì£¼ì†Œ:
      <input type="text" id="address" placeholder="ì˜ˆ: ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 123-45" required>
    </label>
    <label>ì—°ë½ì²˜:
      <input type="text" id="contact" placeholder="ì˜ˆ: 010-1234-5678" required>
    </label>
  </div>

  <div class="section">
    <h2>ğŸ’³ ê²°ì œ ì •ë³´</h2>
    <label>ì¹´ë“œ ë²ˆí˜¸:
      <input type="text" id="cardNumber" placeholder="ì˜ˆ: 1234-5678-9876-5432" required>
    </label>
    <label>ì¹´ë“œ ë¹„ë°€ë²ˆí˜¸:
      <input type="password" id="cardPwd" placeholder="ë¹„ë°€ë²ˆí˜¸ ì• 2ìë¦¬" required>
    </label>
  </div>

  <div class="section summary">
    ì´ ê²°ì œ ê¸ˆì•¡: <span id="totalPrice">0</span> ì›
  </div>

  <div style="text-align: center;">
    <button class="btn" id="pay-btn">âœ… ê²°ì œí•˜ê¸°</button>
  </div>

  <script>
    const user = JSON.parse(localStorage.getItem('user'));
    const token = localStorage.getItem('token');
    const items = JSON.parse(localStorage.getItem('orderItems')) || [];
    const orderDiv = document.getElementById('order-items');
    const totalPriceEl = document.getElementById('totalPrice');

    if (!user || !token) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      location.href = '/login.html';
    }

    let total = 0;
    for (const item of items) {
      const div = document.createElement('div');
      div.className = 'order-item';
      div.innerHTML = `
        <img src="${item.imagePath ? '/' + item.imagePath.replace(/^\/?/, '') : 'noimage.jpg'}" />
        <div>
          <p><strong>${item.productName}</strong></p>
          <p>ìˆ˜ëŸ‰: ${item.productCnt}</p>
          <p>ê¸ˆì•¡: ${(item.productCnt * item.price).toLocaleString()} ì›</p>
        </div>
      `;
      orderDiv.appendChild(div);
      total += item.productCnt * item.price;
    }

    totalPriceEl.innerText = total.toLocaleString();

    document.getElementById('pay-btn').addEventListener('click', async () => {
      const address = document.getElementById('address').value.trim();
      const contact = document.getElementById('contact').value.trim();
      const cardNumber = document.getElementById('cardNumber').value.trim();
      const cardPwd = document.getElementById('cardPwd').value.trim();

      if (!address || !contact || !cardNumber || !cardPwd) {
        alert('ë°°ì†¡ì§€ì™€ ê²°ì œ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        for (const item of items) {
          await fetch('/payment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              userNumber: user.userNumber,
              productID: item.productID,
              productName: item.productName,
              productCnt: item.productCnt,
              creditCardNumber: cardNumber,
              creditCardPwd: cardPwd,
              address,
              contact,
              totalPrice: item.productCnt * item.price,
              imagePath: item.imagePath
            })
          });

          await fetch(`/cart/${item.cartId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
        }

        alert('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        localStorage.removeItem('orderItems');
        location.href = '/orders.html';
      } catch (err) {
        console.error('ê²°ì œ ì˜¤ë¥˜:', err);
        alert('ê²°ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });
  </script>
</body>
</html>
